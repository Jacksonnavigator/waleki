{"ast":null,"code":"// NotificationService.js - Push + Beem Africa SMS Alerts\n\nclass NotificationService {\n  constructor() {\n    // ===========================================================\n    // 1Ô∏è‚É£ BEEM AFRICA SMS CONFIG\n    // ===========================================================\n    this.BEEM_API_KEY = \"\";\n    // <-- Replace\n    this.BEEM_SECRET_KEY = \"\";\n    // <-- Replace\n    this.SENDER_ID = \"\";\n    // <-- Replace (must be approved)\n    this.PHONE_NUMBER = \"\";\n    this.permission = 'default';\n    this.monitoring = new Map();\n    this.checkInterval = null;\n    this.CHECK_INTERVAL_MS = 60000; // 1 minute\n    this.TIMEOUT_MS = 300000; // 5 minutes\n    this.notifiedNodes = new Set();\n  }\n  // <-- Replace (no +)\n\n  // ===========================================================\n  // 2Ô∏è‚É£ SEND SMS USING BEEM AFRICA API\n  // ===========================================================\n  async sendSMS(message) {\n    try {\n      const body = {\n        source_addr: this.SENDER_ID,\n        schedule_time: \"\",\n        encoding: 0,\n        message: message,\n        recipients: [{\n          recipient_id: 1,\n          dest_addr: this.PHONE_NUMBER\n        }]\n      };\n      const response = await fetch(\"https://api.beem.africa/v1/send\", {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n          Authorization: \"Basic \" + btoa(`${this.BEEM_API_KEY}:${this.BEEM_SECRET_KEY}`)\n        },\n        body: JSON.stringify(body)\n      });\n      const result = await response.json();\n      console.log(\"üì® Beem SMS Response:\", result);\n    } catch (error) {\n      console.error(\"‚ùå Error sending Beem SMS:\", error);\n    }\n  }\n\n  // ===========================================================\n  // 3Ô∏è‚É£ Initialize Push Notifications\n  // ===========================================================\n  async init() {\n    if (!(\"Notification\" in window)) return false;\n    this.permission = Notification.permission;\n    if (this.permission === \"granted\") {\n      this.startMonitoring();\n    }\n    return this.permission === \"granted\";\n  }\n  async requestPermission() {\n    const permission = await Notification.requestPermission();\n    this.permission = permission;\n    if (permission === \"granted\") {\n      this.startMonitoring();\n    }\n    return permission === \"granted\";\n  }\n\n  // ===========================================================\n  // 4Ô∏è‚É£ Monitoring\n  // ===========================================================\n  startMonitoring() {\n    if (this.checkInterval) clearInterval(this.checkInterval);\n    this.checkInterval = setInterval(() => {\n      this.checkDataFlow();\n    }, this.CHECK_INTERVAL_MS);\n  }\n  stopMonitoring() {\n    clearInterval(this.checkInterval);\n    this.checkInterval = null;\n  }\n  updateNodeTimestamp(nodeId, timestamp) {\n    const now = Date.now();\n    const timestampMs = new Date(timestamp).getTime();\n    const previous = this.monitoring.get(nodeId);\n    this.monitoring.set(nodeId, {\n      lastUpdate: timestampMs,\n      lastCheck: now\n    });\n\n    // üîµ NODE BACK ONLINE\n    if (previous && this.notifiedNodes.has(`${nodeId}-offline`)) {\n      this.notifiedNodes.delete(`${nodeId}-offline`);\n      const msg = `‚úÖ SYSTEM ONLINE\\n${nodeId} has resumed sending data.`;\n      this.sendSMS(msg);\n      this.showNotification(`‚úÖ ${nodeId} Back Online`, `Sensor has resumed data transmission.`, {\n        tag: `${nodeId}-online`\n      });\n    }\n  }\n\n  // ===========================================================\n  // 5Ô∏è‚É£ Check if system is DOWN\n  // ===========================================================\n  checkDataFlow() {\n    const now = Date.now();\n    this.monitoring.forEach((data, nodeId) => {\n      const timeSinceUpdate = now - data.lastUpdate;\n      if (timeSinceUpdate > this.TIMEOUT_MS) {\n        const key = `${nodeId}-offline`;\n        if (!this.notifiedNodes.has(key)) {\n          this.notifiedNodes.add(key);\n          const minutes = Math.floor(timeSinceUpdate / 60000);\n          const smsText = `‚ö†Ô∏è SYSTEM DOWN\\n${nodeId} has been offline for ${minutes} minutes.`;\n\n          // üì© Send SMS using Beem\n          this.sendSMS(smsText);\n\n          // üîî Show push notification\n          this.showNotification(`‚ö†Ô∏è ${nodeId} OFFLINE`, `No data for ${minutes} minutes.`, {\n            tag: key\n          });\n        }\n      }\n    });\n  }\n\n  // ===========================================================\n  // 6Ô∏è‚É£ Push Notification\n  // ===========================================================\n  showNotification(title, body, options = {}) {\n    if (this.permission !== \"granted\") return;\n    const notification = new Notification(title, {\n      body,\n      icon: \"/waleki-logo.png\",\n      badge: \"/waleki-badge.png\",\n      ...options\n    });\n    setTimeout(() => notification.close(), 8000);\n    return notification;\n  }\n\n  // ===========================================================\n  // 7Ô∏è‚É£ Utilities\n  // ===========================================================\n  getMonitoringStatus() {\n    const now = Date.now();\n    const status = {};\n    this.monitoring.forEach((data, id) => {\n      status[id] = {\n        lastUpdate: new Date(data.lastUpdate).toISOString(),\n        minutesOffline: Math.floor((now - data.lastUpdate) / 60000),\n        isOnline: now - data.lastUpdate < this.TIMEOUT_MS\n      };\n    });\n    return status;\n  }\n  clearNotifications() {\n    this.notifiedNodes.clear();\n  }\n  destroy() {\n    this.stopMonitoring();\n    this.monitoring.clear();\n    this.notifiedNodes.clear();\n  }\n}\nconst notificationService = new NotificationService();\nexport default notificationService;","map":{"version":3,"names":["NotificationService","constructor","BEEM_API_KEY","BEEM_SECRET_KEY","SENDER_ID","PHONE_NUMBER","permission","monitoring","Map","checkInterval","CHECK_INTERVAL_MS","TIMEOUT_MS","notifiedNodes","Set","sendSMS","message","body","source_addr","schedule_time","encoding","recipients","recipient_id","dest_addr","response","fetch","method","headers","Authorization","btoa","JSON","stringify","result","json","console","log","error","init","window","Notification","startMonitoring","requestPermission","clearInterval","setInterval","checkDataFlow","stopMonitoring","updateNodeTimestamp","nodeId","timestamp","now","Date","timestampMs","getTime","previous","get","set","lastUpdate","lastCheck","has","delete","msg","showNotification","tag","forEach","data","timeSinceUpdate","key","add","minutes","Math","floor","smsText","title","options","notification","icon","badge","setTimeout","close","getMonitoringStatus","status","id","toISOString","minutesOffline","isOnline","clearNotifications","clear","destroy","notificationService"],"sources":["/run/media/thobbs/EastManPhoenyXP/WALEKI_FRONTEND/WALEKI-FRONT/src/services/NotificationService.js"],"sourcesContent":["// NotificationService.js - Push + Beem Africa SMS Alerts\n\nclass NotificationService {\n  constructor() {\n    this.permission = 'default';\n    this.monitoring = new Map();\n    this.checkInterval = null;\n\n    this.CHECK_INTERVAL_MS = 60000; // 1 minute\n    this.TIMEOUT_MS = 300000;       // 5 minutes\n    this.notifiedNodes = new Set();\n  }\n\n  // ===========================================================\n  // 1Ô∏è‚É£ BEEM AFRICA SMS CONFIG\n  // ===========================================================\n  BEEM_API_KEY = \"\";        // <-- Replace\n  BEEM_SECRET_KEY = \"\";  // <-- Replace\n  SENDER_ID = \"\";                // <-- Replace (must be approved)\n  PHONE_NUMBER = \"\";        // <-- Replace (no +)\n\n  // ===========================================================\n  // 2Ô∏è‚É£ SEND SMS USING BEEM AFRICA API\n  // ===========================================================\n  async sendSMS(message) {\n    try {\n      const body = {\n        source_addr: this.SENDER_ID,\n        schedule_time: \"\",\n        encoding: 0,\n        message: message,\n        recipients: [\n          {\n            recipient_id: 1,\n            dest_addr: this.PHONE_NUMBER\n          }\n        ]\n      };\n\n      const response = await fetch(\"https://api.beem.africa/v1/send\", {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n          Authorization:\n            \"Basic \" +\n            btoa(`${this.BEEM_API_KEY}:${this.BEEM_SECRET_KEY}`)\n        },\n        body: JSON.stringify(body)\n      });\n\n      const result = await response.json();\n      console.log(\"üì® Beem SMS Response:\", result);\n\n    } catch (error) {\n      console.error(\"‚ùå Error sending Beem SMS:\", error);\n    }\n  }\n\n  // ===========================================================\n  // 3Ô∏è‚É£ Initialize Push Notifications\n  // ===========================================================\n  async init() {\n    if (!(\"Notification\" in window)) return false;\n\n    this.permission = Notification.permission;\n\n    if (this.permission === \"granted\") {\n      this.startMonitoring();\n    }\n\n    return this.permission === \"granted\";\n  }\n\n  async requestPermission() {\n    const permission = await Notification.requestPermission();\n    this.permission = permission;\n\n    if (permission === \"granted\") {\n      this.startMonitoring();\n    }\n\n    return permission === \"granted\";\n  }\n\n  // ===========================================================\n  // 4Ô∏è‚É£ Monitoring\n  // ===========================================================\n  startMonitoring() {\n    if (this.checkInterval) clearInterval(this.checkInterval);\n\n    this.checkInterval = setInterval(() => {\n      this.checkDataFlow();\n    }, this.CHECK_INTERVAL_MS);\n  }\n\n  stopMonitoring() {\n    clearInterval(this.checkInterval);\n    this.checkInterval = null;\n  }\n\n  updateNodeTimestamp(nodeId, timestamp) {\n    const now = Date.now();\n    const timestampMs = new Date(timestamp).getTime();\n    const previous = this.monitoring.get(nodeId);\n\n    this.monitoring.set(nodeId, {\n      lastUpdate: timestampMs,\n      lastCheck: now\n    });\n\n    // üîµ NODE BACK ONLINE\n    if (previous && this.notifiedNodes.has(`${nodeId}-offline`)) {\n      this.notifiedNodes.delete(`${nodeId}-offline`);\n\n      const msg = `‚úÖ SYSTEM ONLINE\\n${nodeId} has resumed sending data.`;\n      this.sendSMS(msg);\n\n      this.showNotification(\n        `‚úÖ ${nodeId} Back Online`,\n        `Sensor has resumed data transmission.`,\n        { tag: `${nodeId}-online` }\n      );\n    }\n  }\n\n  // ===========================================================\n  // 5Ô∏è‚É£ Check if system is DOWN\n  // ===========================================================\n  checkDataFlow() {\n    const now = Date.now();\n\n    this.monitoring.forEach((data, nodeId) => {\n      const timeSinceUpdate = now - data.lastUpdate;\n\n      if (timeSinceUpdate > this.TIMEOUT_MS) {\n        const key = `${nodeId}-offline`;\n\n        if (!this.notifiedNodes.has(key)) {\n          this.notifiedNodes.add(key);\n\n          const minutes = Math.floor(timeSinceUpdate / 60000);\n\n          const smsText = `‚ö†Ô∏è SYSTEM DOWN\\n${nodeId} has been offline for ${minutes} minutes.`;\n\n          // üì© Send SMS using Beem\n          this.sendSMS(smsText);\n\n          // üîî Show push notification\n          this.showNotification(\n            `‚ö†Ô∏è ${nodeId} OFFLINE`,\n            `No data for ${minutes} minutes.`,\n            { tag: key }\n          );\n        }\n      }\n    });\n  }\n\n  // ===========================================================\n  // 6Ô∏è‚É£ Push Notification\n  // ===========================================================\n  showNotification(title, body, options = {}) {\n    if (this.permission !== \"granted\") return;\n\n    const notification = new Notification(title, {\n      body,\n      icon: \"/waleki-logo.png\",\n      badge: \"/waleki-badge.png\",\n      ...options\n    });\n\n    setTimeout(() => notification.close(), 8000);\n\n    return notification;\n  }\n\n  // ===========================================================\n  // 7Ô∏è‚É£ Utilities\n  // ===========================================================\n  getMonitoringStatus() {\n    const now = Date.now();\n    const status = {};\n\n    this.monitoring.forEach((data, id) => {\n      status[id] = {\n        lastUpdate: new Date(data.lastUpdate).toISOString(),\n        minutesOffline: Math.floor((now - data.lastUpdate) / 60000),\n        isOnline: now - data.lastUpdate < this.TIMEOUT_MS\n      };\n    });\n\n    return status;\n  }\n\n  clearNotifications() {\n    this.notifiedNodes.clear();\n  }\n\n  destroy() {\n    this.stopMonitoring();\n    this.monitoring.clear();\n    this.notifiedNodes.clear();\n  }\n}\n\nconst notificationService = new NotificationService();\nexport default notificationService;\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}